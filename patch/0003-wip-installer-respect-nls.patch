# HG changeset patch
# Parent  10b7070722fd890f74357389037b9e6db6f6235f

diff --git a/nsis/gvim.nsi b/nsis/gvim.nsi
--- a/nsis/gvim.nsi
+++ b/nsis/gvim.nsi
@@ -329,88 +329,10 @@ Section "Add Vim to the Start Menu"
 SectionEnd
 
 ##########################################################
-Section "Add an Edit-with-Vim context menu entry"
+Section "Add an Edit-with-Vim context menu entry" sec_gvimext_id
 	SectionIn 1 3
 
-	# Be aware of this sequence of events:
-	# - user uninstalls Vim, gvimext.dll can't be removed (it's in use) and
-	#   is scheduled to be removed at next reboot.
-	# - user installs Vim in same directory, gvimext.dll still exists.
-	# If we now skip installing gvimext.dll, it will disappear at the next
-	# reboot.  Thus when copying gvimext.dll fails always schedule it to be
-	# installed at the next reboot.  Can't use UpgradeDLL!
-	# We don't ask the user to reboot, the old dll will keep on working.
-	SetOutPath $0
-	ClearErrors
-	SetOverwrite try
-
-	${If} ${RunningX64}
-	  # Install 64-bit gvimext.dll into the GvimExt64 directory.
-	  SetOutPath $0\GvimExt64
-	  ClearErrors
-	  File /oname=gvimext.dll ${VIMSRC}\GvimExt\gvimext64.dll
-!ifdef HAVE_NLS
-	  File ${GETTEXT}\gettext64\libintl-8.dll
-	  File ${GETTEXT}\gettext64\libiconv-2.dll
-!endif
-
-	  ${If} ${Errors}
-	    # Can't copy gvimext.dll, create it under another name and rename it
-	    # on next reboot.
-	    GetTempFileName $3 $0\GvimExt64
-	    File /oname=$3 ${VIMSRC}\GvimExt\gvimext64.dll
-	    Rename /REBOOTOK $3 $0\GvimExt64\gvimext.dll
-!ifdef HAVE_NLS
-	    GetTempFileName $3 $0\GvimExt64
-	    File /oname=$3 ${GETTEXT}\gettext64\libintl-8.dll
-	    Rename /REBOOTOK $3 $0\GvimExt64\libintl-8.dll
-	    GetTempFileName $3 $0\GvimExt64
-	    File /oname=$3 ${GETTEXT}\gettext64\libiconv-2.dll
-	    Rename /REBOOTOK $3 $0\GvimExt64\libiconv-2.dll
-!endif
-	  ${EndIf}
-	${EndIf}
-
-	# Install 32-bit gvimext.dll into the GvimExt32 directory.
-	SetOutPath $0\GvimExt32
-	ClearErrors
-
-	File /oname=gvimext.dll ${VIMSRC}\GvimExt\gvimext.dll
-!ifdef HAVE_NLS
-	File ${GETTEXT}\gettext32\libintl-8.dll
-	File ${GETTEXT}\gettext32\libiconv-2.dll
-  !if /FileExists "${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll"
-	# Install libgcc_s_sjlj-1.dll only if it is needed.
-	File ${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll
-  !endif
-!endif
-
-	${If} ${Errors}
-	  # Can't copy gvimext.dll, create it under another name and rename it on
-	  # next reboot.
-	  GetTempFileName $3 $0\GvimExt32
-	  File /oname=$3 ${VIMSRC}\GvimExt\gvimext.dll
-	  Rename /REBOOTOK $3 $0\GvimExt32\gvimext.dll
-!ifdef HAVE_NLS
-	  GetTempFileName $3 $0\GvimExt32
-	  File /oname=$3 ${GETTEXT}\gettext32\libintl-8.dll
-	  Rename /REBOOTOK $3 $0\GvimExt32\libintl-8.dll
-	  GetTempFileName $3 $0\GvimExt32
-	  File /oname=$3 ${GETTEXT}\gettext32\libiconv-2.dll
-	  Rename /REBOOTOK $3 $0\GvimExt32\libiconv-2.dll
-  !if /FileExists "${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll"
-	  # Install libgcc_s_sjlj-1.dll only if it is needed.
-	  GetTempFileName $3 $0\GvimExt32
-	  File /oname=$3 ${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll
-	  Rename /REBOOTOK $3 $0\GvimExt32\libgcc_s_sjlj-1.dll
-  !endif
-!endif
-	${EndIf}
-	SetOverwrite lastused
-
-	# We don't have a separate entry for the "Open With..." menu, assume
-	# the user wants either both or none.
-	StrCpy $1 "$1 -install-popup -install-openwith"
+	# Do actual installation in a later hidden section.
 SectionEnd
 
 ##########################################################
@@ -445,7 +367,7 @@ SectionEnd
 
 ##########################################################
 !ifdef HAVE_NLS
-Section "Native Language Support"
+Section "Native Language Support" sec_nls_id
 	SectionIn 1 3
 
 	SetOutPath $0\lang
@@ -465,6 +387,102 @@ SectionEnd
 !endif
 
 ##########################################################
+Section -do_install_gvimext
+
+	${IfNot} ${SectionIsSelected} ${sec_gvimext_id}
+	  Return
+	${EndIf}
+
+	# Be aware of this sequence of events:
+	# - user uninstalls Vim, gvimext.dll can't be removed (it's in use) and
+	#   is scheduled to be removed at next reboot.
+	# - user installs Vim in same directory, gvimext.dll still exists.
+	# If we now skip installing gvimext.dll, it will disappear at the next
+	# reboot.  Thus when copying gvimext.dll fails always schedule it to be
+	# installed at the next reboot.  Can't use UpgradeDLL!
+	# We don't ask the user to reboot, the old dll will keep on working.
+	SetOutPath $0
+	ClearErrors
+	SetOverwrite try
+
+	${If} ${RunningX64}
+	  # Install 64-bit gvimext.dll into the GvimExt64 directory.
+	  SetOutPath $0\GvimExt64
+	  ClearErrors
+	  File /oname=gvimext.dll ${VIMSRC}\GvimExt\gvimext64.dll
+!ifdef HAVE_NLS
+	  ${If} ${SectionIsSelected} ${sec_nls_id}
+	    File ${GETTEXT}\gettext64\libintl-8.dll
+	    File ${GETTEXT}\gettext64\libiconv-2.dll
+	  ${EndIf}
+!endif
+
+	  ${If} ${Errors}
+	    # Can't copy gvimext.dll, create it under another name and rename it
+	    # on next reboot.
+	    GetTempFileName $3 $0\GvimExt64
+	    File /oname=$3 ${VIMSRC}\GvimExt\gvimext64.dll
+	    Rename /REBOOTOK $3 $0\GvimExt64\gvimext.dll
+!ifdef HAVE_NLS
+	    ${If} ${SectionIsSelected} ${sec_nls_id}
+	      GetTempFileName $3 $0\GvimExt64
+	      File /oname=$3 ${GETTEXT}\gettext64\libintl-8.dll
+	      Rename /REBOOTOK $3 $0\GvimExt64\libintl-8.dll
+	      GetTempFileName $3 $0\GvimExt64
+	      File /oname=$3 ${GETTEXT}\gettext64\libiconv-2.dll
+	      Rename /REBOOTOK $3 $0\GvimExt64\libiconv-2.dll
+	    ${EndIf}
+!endif
+	  ${EndIf}
+	${EndIf}
+
+	# Install 32-bit gvimext.dll into the GvimExt32 directory.
+	SetOutPath $0\GvimExt32
+	ClearErrors
+
+	File /oname=gvimext.dll ${VIMSRC}\GvimExt\gvimext.dll
+!ifdef HAVE_NLS
+	${If} ${SectionIsSelected} ${sec_nls_id}
+	  File ${GETTEXT}\gettext32\libintl-8.dll
+	  File ${GETTEXT}\gettext32\libiconv-2.dll
+  !if /FileExists "${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll"
+	  # Install libgcc_s_sjlj-1.dll only if it is needed.
+	  File ${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll
+  !endif
+	${EndIf}
+!endif
+
+	${If} ${Errors}
+	  # Can't copy gvimext.dll, create it under another name and rename it
+	  # on next reboot.
+	  GetTempFileName $3 $0\GvimExt32
+	  File /oname=$3 ${VIMSRC}\GvimExt\gvimext.dll
+	  Rename /REBOOTOK $3 $0\GvimExt32\gvimext.dll
+!ifdef HAVE_NLS
+	  ${If} ${SectionIsSelected} ${sec_nls_id}
+	    GetTempFileName $3 $0\GvimExt32
+	    File /oname=$3 ${GETTEXT}\gettext32\libintl-8.dll
+	    Rename /REBOOTOK $3 $0\GvimExt32\libintl-8.dll
+	    GetTempFileName $3 $0\GvimExt32
+	    File /oname=$3 ${GETTEXT}\gettext32\libiconv-2.dll
+	    Rename /REBOOTOK $3 $0\GvimExt32\libiconv-2.dll
+  !if /FileExists "${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll"
+	    # Install libgcc_s_sjlj-1.dll only if it is needed.
+	    GetTempFileName $3 $0\GvimExt32
+	    File /oname=$3 ${GETTEXT}\gettext32\libgcc_s_sjlj-1.dll
+	    Rename /REBOOTOK $3 $0\GvimExt32\libgcc_s_sjlj-1.dll
+  !endif
+	  ${EndIf}
+!endif
+	${EndIf}
+	SetOverwrite lastused
+
+	# We don't have a separate entry for the "Open With..." menu, assume
+	# the user wants either both or none.
+	StrCpy $1 "$1 -install-popup -install-openwith"
+SectionEnd
+
+##########################################################
 Section -call_install_exe
 	SetOutPath $0
 	ExecWait "$0\install.exe $1"
